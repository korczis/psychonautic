{% extends "base.html" %}

{% block body %}
<!-- Reading Progress -->
<div class="reading-progress" x-ref="progress"></div>

<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" :class="{ 'sidebar--open': sidebarOpen }">
        <div class="sidebar__header">
            {% if config.extra.logo %}
            <a href="{{ config.base_url | safe }}" class="sidebar__logo">
                <img src="{{ get_url(path=config.extra.logo) | safe }}" alt="{{ config.title }}">
            </a>
            {% else %}
            <a href="{{ config.base_url | safe }}" class="sidebar__title">{{ config.title }}</a>
            {% endif %}
        </div>

        <nav class="sidebar__nav">
            {% set section = get_section(path="_index.md") %}
            {# Build array of subsections with titles for sorting #}
            {% set_global subsections_list = [] %}
            {% for subsection_path in section.subsections %}
                {% set subsection = get_section(path=subsection_path) %}
                {% set_global subsections_list = subsections_list | concat(with=[subsection]) %}
            {% endfor %}
            {% for subsection in subsections_list | sort(attribute="title") %}
                {% set has_content = subsection.pages | length > 0 or subsection.subsections | length > 0 %}
                <div class="nav-group" x-data="{ open: {% if current_path is starting_with(subsection.path) %}true{% else %}false{% endif %} }">
                    {% if has_content %}
                    <button class="nav-group__toggle" @click="open = !open">
                        <span>{{ subsection.title }}</span>
                        <svg class="nav-group__icon" :class="{ 'nav-group__icon--open': open }" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="nav-group__items" x-show="open" x-collapse>
                        {# Nested subsections sorted alphabetically #}
                        {% set_global nested_list = [] %}
                        {% for nested_path in subsection.subsections %}
                            {% set nested = get_section(path=nested_path) %}
                            {% set_global nested_list = nested_list | concat(with=[nested]) %}
                        {% endfor %}
                        {% for nested in nested_list | sort(attribute="title") %}
                            <div class="nav-subgroup" x-data="{ subopen: {% if current_path is starting_with(nested.path) %}true{% else %}false{% endif %} }">
                                <button class="nav-subgroup__toggle" @click="subopen = !subopen">
                                    <span>{{ nested.title }}</span>
                                    <svg class="nav-subgroup__icon" :class="{ 'nav-subgroup__icon--open': subopen }" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </button>
                                <div class="nav-subgroup__items" x-show="subopen" x-collapse>
                                    {% for page in nested.pages | sort(attribute="title") %}
                                    <a href="{{ page.permalink | safe }}" class="nav-link {% if current_path == page.path %}nav-link--active{% endif %}">
                                        {{ page.title }}
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                        {# Direct pages sorted alphabetically #}
                        {% for page in subsection.pages | sort(attribute="title") %}
                        <a href="{{ page.permalink | safe }}" class="nav-link {% if current_path == page.path %}nav-link--active{% endif %}">
                            {{ page.title }}
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <a href="{{ subsection.permalink | safe }}" class="nav-group__link">
                        <span>{{ subsection.title }}</span>
                    </a>
                    {% endif %}
                </div>
            {% endfor %}
        </nav>

        <div class="sidebar__footer">
            <button class="theme-toggle" @click="toggleDarkMode()" :title="darkMode ? 'Světlý režim' : 'Tmavý režim'">
                <svg x-show="!darkMode" class="theme-toggle__icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                </svg>
                <svg x-show="darkMode" class="theme-toggle__icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </aside>

    <!-- Mobile header -->
    <header class="mobile-header">
        <button class="mobile-header__toggle" @click="sidebarOpen = !sidebarOpen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
        <span class="mobile-header__title">{{ config.title }}</span>
    </header>

    <!-- Main content -->
    <main class="main">
        {% if config.build_search_index %}
        <div class="search-wrapper">
            <div class="search" x-data="search()">
                <input type="search" class="search__input" placeholder="Hledat..." x-model="query" @input.debounce.300ms="doSearch()">
                <div class="search__results" x-show="results.length > 0" x-transition>
                    <template x-for="result in results" :key="result.ref">
                        <a :href="result.ref" class="search__result" x-text="result.doc.title"></a>
                    </template>
                </div>
            </div>
        </div>
        {% endif %}

        <article class="content">
            {% block content %}
            {% if section.content %}
                {{ section.content | safe }}
            {% else %}
                <h1>{{ section.title }}</h1>
                {% if section.description %}
                <p class="lead">{{ section.description }}</p>
                {% endif %}
            {% endif %}
            {% endblock %}
        </article>

        <footer class="footer">
            <p>Vytvořeno pomocí <a href="https://getzola.org">Zola</a> + Psychonautic theme</p>
        </footer>
    </main>
</div>

<!-- Back to top -->
<button class="back-to-top" x-show="showBackToTop" x-transition @click="scrollToTop()">
    <svg viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/>
    </svg>
</button>

<!-- Overlay for mobile -->
<div class="sidebar-overlay" x-show="sidebarOpen" x-transition.opacity @click="sidebarOpen = false"></div>
{% endblock %}
